# 文件同步与一致性探讨

## 为什么需要文件同步？

在多节点多活架构中，任意节点都可能承担用户请求。如果节点之间的内容不同步，就会导致：
- 部分节点显示新文章，部分节点还看不到。
- SEO 爬虫在不同节点抓取到不一致的页面。
- 某些功能性配置或菜单错乱。

因此需要在多活环境下保持各节点数据库内容大体一致。

---

## 当前的最小化同步策略

在本方案中，采用极简的单向同步架构：

- 🏠 **家宽节点作为主写节点**  
  所有文章发布、站点配置都只在这里执行。
  
- 🌎 **VPS 节点为只读节点**  
  仅参与 Cloudflare Tunnel 流量调度，不进行任何写操作。

- ☁ **媒体文件全部托管在对象存储（R2）**  
  各节点通过统一 URL 加载，无需做文件层同步。

- 🔄 **只同步 `wordpress.sql` 数据库导出文件**  
  由 家宽节点定期推送至VPS节点，并在远端自动导入，保持最终一致。

---

## 为什么只同步数据库？

- WordPress 核心、主题、必要插件都在各节点保持相同版本，通过 SSH / Git / wp-cli 升级维护。
- 部分只需在主节点执行的插件（如：
  - Cloudflare APO：避免远程节点意外触发缓存刷新。
  - WPvivid Backup：在本地定期备份到 Docker 外接硬盘。
  - Simply Static、WP-Optimize：用于生成静态站和定期优化数据库）
  都只安装在家宽节点上。
  
因此实际同步只需针对数据库即可。

---

## 文件同步示例流程

在家宽节点：
```bash
mysqldump -u root -p yourdb > /var/www/html/wordpress.sql
rsync -avz /var/www/html/wordpress.sql user@vps:/var/www/html/
```
小技巧：可以同步成wordpress.sql.tmp，同步完成之后再改名sql文件，这样可以保证文件在未传送完之前不会被远端导入数据库造成数据库损坏。

在 VPS：
```
mysql -u root -p yourdb < /var/www/html/wordpress.sql
```
可通过inotify监测指定目录中的wordpress.sql文件变化实现自动同步。

⸻

关于一致性与可用性

这种架构属于典型的：
- 最终一致性（eventual consistency）：在同步周期内，可能存在短暂数据延迟。
- 对于以「读多写少」为主的博客场景而言，完全可接受。
- 若主节点短暂离线，其他节点依旧可以提供完整读取服务。

---

## 小结

通过对象存储承载媒体文件 + 单向同步数据库的方式：
- 大幅简化多活架构下的同步复杂度。
- 避免多节点文件覆盖冲突。
- 兼顾多节点可用性与易维护性，非常适合个人博客场景。

---

## 后续章节预览

- 📌 [下一章：进阶优化](./04-advanced-optimizations.md)

---