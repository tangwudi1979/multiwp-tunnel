# 架构概览

## 为什么需要多节点多活？

随着个人博客内容越来越多，依赖单个源站存在显著缺点：
- 家宽停电、跳闸、偶发断网就会全站不可用；VPS也未必就非常保险。
- 用户分布在不同地域，访问家里或单一 VPS 延迟可能显著增加。。
- 某些云厂商机房偶发丢包或被墙。

为了让博客具备更高的可用性与更好的用户体验，我探索了一种**简版WordPress多活架构**，即：
- 在不同地域（家庭节点、VPS节点）同时部署相同的站点内容。
- 使用 Cloudflare Tunnel 接入，让 Edge 根据网络状况 best effort 分配。
- 通过手动/定时数据库同步保持节点间内容一致。

---

## 简版多活架构目标

- ✈ **多地域多入口**：在家里、VPS 同时跑一个完整站点，避免单点。
- 🔄 **文件弱一致性**：通过 rsync 手动/定时同步数据库文件，保证文章/评论更新后能逐步同步到所有节点。
- 🌐 **依赖 Cloudflare Edge 调度**：利用 Cloudflare 的全球 Anycast 网络 + Tunnel 自动探活与流量调度。
- 🔥 **可选 APO**：可在边缘做更 aggressive 的缓存，显著减少回源。。

这样就算某个节点短暂离线，Cloudflare 会自动尝试下一个节点，整体保持对用户可用，这种架构支持的多活节点最高是25个(这是Cloudflare单个Tunnel下支持的connector的上限)。

---

## 架构总览

用户 -> Cloudflare Edge (best effort)
       /       |       \
      v        v        v
  家庭节点   VPS节点   未来节点
       \       |       /
   +-- 库文件按需 / 定时同步 --+
            (rsync)

---

## 方案核心组件

- **Cloudflare Tunnel**  
  - 每个节点运行 cloudflared，注册到同一个域名(公共主机名)所在的Tunnel。
  - Cloudflare 自动探测各节点的可用性，按最优路线回源。

- **数据库文件同步 (rsync)**  
  - 目前按需采用单向 rsync，将家里的 WordPress 数据库导出文件同步至远端 VPS 节点。
  - 这种方式基于脚本实现，不受远端节点数量限制，只需为每个节点添加相应的命令条目即可。
  - 对于需要多节点同时写入的场景，则需采用更复杂的分布式文件系统架构，已超出本方案设计范围。。
  - 多活部署的前提是多节点公用的文件要脱离本地，比如图床要使用云端图床。

- **Edge 缓存 (APO 可选)**  
  - WordPress建议搭配 APO 提高缓存命中率，减轻节点压力。

---

## 后续章节预览

- 📌 [下一章：Cloudflare Tunnel 实现细节](./02-cloudflare-tunnel.md)

---